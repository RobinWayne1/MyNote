# Blog 2 多级缓存方案

### 一、介绍

TMC，即“透明多级缓存（Transparent Multilevel Cache）”，是有赞 PaaS 团队给公司内应用提供的整体缓存解决方案。

TMC 在通用“分布式缓存解决方案（如 CodisProxy + Redis，如有赞自研分布式缓存系统 zanKV）”基础上，增加了以下功能：

- 应用层热点探测
- 应用层本地缓存
- 应用层缓存命中统计

以帮助应用层解决缓存使用过程中出现的热点访问问题。

### 二、背景

使用有赞服务的电商商家数量和类型很多，商家会不定期做一些“商品秒杀”、“商品推广”活动，导致“营销活动”、“商品详情”、“交易下单”等链路应用出现 缓存热点访问的情况：

- ==活动时间、活动类型、活动商品之类的信息不可预期，导致 缓存热点访问 情况不可提前预知；==
- ==缓存热点访问 出现期间，应用层少数 热点访问 key 产生大量缓存访问请求：冲击分布式缓存系统，大量占据内网带宽，最终影响应用层系统稳定性；==

为了应对以上问题，需要一个能够 ==自动发现热点== 并 ==将热点缓存访问请求前置**在应用层本地缓存**==的解决方案，这就是 TMC 产生的原因。

### 三、多级缓存解决方案的痛点

基于上述描述，我们总结了下列 多级缓存解决方案需要解决的需求痛点：

- 热点探测：如何快速且准确的发现 热点访问 key ？
- 数据一致性：前置在应用层的本地缓存，如何保障与分布式缓存系统的数据一致性？
- 效果验证：如何让应用层查看本地缓存命中率、热点 key 等数据，验证多级缓存效果？
- 透明接入：整体解决方案如何减少对应用系统的入侵，做到快速平滑接入？

TMC 聚焦上述痛点，设计并实现了整体解决方案。以支持“热点探测”和“本地缓存”，减少热点访问时对下游分布式缓存服务的冲击，避免影响应用服务的性能及稳定性。

### 四、整体结构

模块划分**![img](https://mmbiz.qpic.cn/mmbiz_png/SJm51egHPPFcUyEibIN5pMPLhTMcw84nEl7pgWPicX48DcrDAvf4nwo34URXqgRdueCoiaKD04RXC9SUHSBBTCSUg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)**

TMC 本地缓存整体结构分为如下模块：

- Jedis-Client：Java 应用与缓存服务端交互的直接入口，接口定义与原生 Jedis-Client 无异；
- Hermes-SDK：自研“热点发现+本地缓存”功能的 SDK 封装，Jedis-Client 通过与它交互来集成相应能力；
- Hermes 服务端集群：接收 Hermes-SDK 上报的缓存访问数据，进行热点探测，将热点 key 推送给 Hermes-SDK 做本地缓存；
- 缓存集群：由代理层和存储层组成，为应用客户端提供统一的分布式缓存服务入口；
- 基础组件：etcd 集群、Apollo 配置中心，为 TMC 提供“集群推送”和“统一配置”能力；

### 五、基本流程

1）key 值获取

- Java 应用调用 Jedis-Client 接口获取 key 的缓存值时，Jedis-Client 会询问 Hermes-SDK 该 key 当前是否是 热点key；
- ==对于 热点key ，**直接从 Hermes-SDK 的 热点模块 获取热点 key 在本地缓存的 value 值**，不去访问 缓存集群 ，从而将访问请求前置在应用层；==
- ==对于非 热点key ，Hermes-SDK 会通过 Callable回调 Jedis-Client 的原生接口，从 缓存集群 拿到 value 值；==
- 对于 Jedis-Client 的每次 key 值访问请求，Hermes-SDK 都会通过其 通信模块 **将 key 访问事件 异步上报给 Hermes 服务端集群 ，以便其根据上报数据进行“热点探测”**；

2）key 值过期

- ==Java 应用调用 Jedis-Client 的 set() del() expire()接口时会导致对应 key 值失效，Jedis-Client 会同步调用 Hermes-SDK 的 invalid()方法告知其“key 值失效”事件；==
- ==**对于 热点 key ，Hermes-SDK 的 热点模块 会先将 key 在本地缓存的 value 值失效，以达到本地数据强一致。同时 通信模块 会异步将“key 值失效”事件通过 etcd 集群 推送给 Java 应用集群中其他 Hermes-SDK 节点；**==
- **==其他 Hermes-SDK 节点的 通信模块 收到 “key 值失效”事件后，会调用 热点模块 将 key 在本地缓存的 value 值失效，以达到集群数据最终一致；==**

3）热点发现

- **Hermes 服务端集群 不断收集 Hermes-SDK上报的 key 访问事件，对不同业务应用集群的缓存访问数据进行周期性（3s 一次）分析计算，以探测业务应用集群中的热点 key列表；**
- ==**对于探测到的热点 key列表，Hermes 服务端集群 将其通过 etcd 集群 推送给不同业务应用集群的 Hermes-SDK 通信模块，通知其对热点 key列表进行本地缓存；**==

4）配置读取

- Hermes-SDK 在启动及运行过程中，会从 Apollo 配置中心 读取其关心的配置信息（如：启动关闭配置、黑白名单配置、etcd 地址…）；
- Hermes 服务端集群 在启动及运行过程中，会从 Apollo 配置中心 读取其关心的配置信息（如：业务应用列表、热点阈值配置、etcd 地址…）；

### 稳定性

TMC 本地缓存稳定性表现在以下方面：

- 数据上报异步化：Hermes-SDK 使用 rsyslog技术对“key 访问事件”进行异步化上报，不会阻塞业务；
- **通信模块线程隔离**：Hermes-SDK 的 通信模块 使用独立线程池+有界队列，保证事件上报&监听的 I/O 操作与业务执行线程隔离，即使出现非预期性异常也不会影响基本业务功能；
- 缓存管控：Hermes-SDK 的 热点模块 对本地缓存大小上限进行了管控，使其占用内存不超过 64MB（LRU），杜绝 JVM 堆内存溢出的可能；

### 一致性

TMC 本地缓存一致性表现在以下方面：

- Hermes-SDK 的 热点模块 ==仅缓存 热点 key 数据==，绝大多数非热点 key数据由 缓存集群 存储；
- 热点 key 变更导致 value 失效时，Hermes-SDK 同步失效本地缓存，保证 本地强一致；
- 热点 key 变更导致 value 失效时，Hermes-SDK 通过 etcd 集群 广播事件，异步失效业务应用集群中其他节点的本地缓存，保证 集群最终一致；

