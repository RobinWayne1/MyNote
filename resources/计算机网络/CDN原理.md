# CDN 原理

CDN即是内容分发网络，内容分发网络一般是用作加速访问一些静态资源的访问如css，js等文件。

## 一、背景

一般的公司都会采用动静分离的方式去部署项目，也就是专门用服务器去存放前端的静态资源。这种资源的特点是更新比较少，访问比较多，所以易于缓存。然而，用户一次静态资源的请求需要经过的网络流程如下所示。

![](E:\Typora\MyNote\resources\计算机网络\网络请求过程.png)

用户的HTTP请求会先发往网络服务提供商（ISP，其实就是三大运营商），然后ISP连接着一个更大的网络，这个网络又与其他相似大小的网络相连接，最后才将HTTP请求包送达源服务器。在此中，如果用户离源服务器地理位置比较远，那么在网络转发的过程中所经过的路由器、交换机、运营商网络（跨运营商访问是比较慢的）将会非常多，这将极其影响网站响应速度。

## 二、CDN基于背景的优化

基于上述背景，CDN应运而生。原本用户请求静态资源时都要去源服务器去获取静态资源，然而当CDN出现之后，所请求的静态资源的域名解析出来的IP地址就不再是源服务器的地址，而是CDN服务器（也称为边缘服务器）的IP地址。

<img src="E:\Typora\MyNote\resources\计算机网络\用户请求对比.png" style="zoom:75%;" />

==**返回的边缘服务器IP地址是根据与用户的距离、负载均衡策略等等条件选出的最合适的节点，此时用户将访问资源的请求扔给离自己比较近边缘服务器就可以了。边缘服务器将会负责提供静态资源的获取和返回。**==

## 三、CDN的DNS解析

### Ⅰ、CName(Canonical Name,别名记录)

最基本的DNS解析就是最简单的一层映射，如`www.vip.com`→`14.215.62.23`,这层映射有个术语叫做A记录，即Address记录。而CName就是A记录中域名的一个别名，拿唯品会做例子：<img src="E:\Typora\MyNote\resources\计算机网络\DNS与CName.png"  />

可以看到DNS响应报文中的A记录中的域名就是`www.vip.com`,而这个域名的别名是`shop.vip.com`和`com.vipgslb.com`。那么CName和A记录整体到底有什么关系呢？其实就相当于多了一层别名映射：`shop.vip.com`→`www.vip.com`→`14.215.62.23`和`com.vipgslb.com`→`www.vip.com`→`14.215.62.23`。这种做法的好处就是使得别名并不与IP地址有着直接的联系，别名解析出的IP地址是随着A记录域名（`www.vip.com`）所对应的IP地址的改变而改变的，所以当IP地址改变时，只需要修改A记录的IP地址，CName映射不需要改变也能正常访问目标服务器。

**因此，CName的使用场景就是有多个域名需要映射到同一个IP，并且这个IP会经常改变的情况。** **如果不使用CName，每一个域名就要有一条A记录记录映射,那么修改服务器IP地址就要将这些A记录全部修改一遍，非常麻烦。**

==这种机制就非常适合CDN：**将源服务器域名（或是CDN负载均衡服务器域名）作为边缘服务器的一个CName**，那么在请求源服务器资源时,通过CName域名解析请求就会被重定向到边缘服务器中让其负责代理源服务器。==

### Ⅱ、请求到边缘服务器的流程

![](E:\Typora\MyNote\resources\计算机网络\请求到边缘服务器的流程.png)

![](E:\Typora\MyNote\resources\计算机网络\请求到边缘服务器的流程2.png)

1. 2. 3. 首先，用户请求源服务器的资源，此时这个域名将会走正常的DNS解析流程，最终来到权限域名服务器中。权限域名服务器发现所请求的域名是一个CName，所以将会返回CName对应的A地址域名给本地域名服务器（注意不是IP地址）。

      4. 本地域名服务器看返回来是个域名，此时就会根据新返回域名的NS记录找到处理该域名的DNS调度服务器（CDN服务商会向运营商购买域名如`cdn.com`,之后运营商会在本地DNS中做一个NS记录,即记录匹配`cdn.com`后缀的域名都去DNS调度服务器中解析）

      5. DNS调度服务器此时会根据负载均衡策略、请求距离的远近、又或者是带宽成本等条件去选出一个最合适边缘服务器出来，返回其IP地址给运营商域名服务器

      6. 7. 8. 最后用户浏览器接收到解析后的IP地址，直接向边缘服务器发出请求。边缘服务器根据缓存机制返回资源给客户端。

         

## 四、缓存机制原理

边缘服务器充当一个反向代理的角色，为客户提供数据。

![](E:\Typora\MyNote\resources\计算机网络\缓存机制.png)

当用户第一次请求资源时，边缘服务器查找本地缓存发现没有缓存该资源，于是就会请求源服务器获取资源，这一步操作称作回源。回源得到数据后，边缘服务器就会将这个资源放入本地缓存中，如果下一次还有还有相同请求到达该边缘服务器，那么边缘服务器就会直接返回本地缓存的资源给用户。可以说CDN缓存就是降低网络转发的一个最关键的点，==**如果缓存设计得好，那么回源就会比较少，就能够减少源服务器负载提升性能。**==

有一个需要注意的点就是多个边缘节点的缓存一致性问题（POP），有空再写。

材爷告诉我，边缘服务器的缓存是以整个完整的HTTP请求URL为key的，所以要每次都CDN回源，那么就要在请求参数中设置一个每次请求都会变的变量，如时间戳，才能做到实时更新。不过不同CDN提供商的缓存过期和缓存记录格式都不同，这只是唯品会使用CDN的特例，看看就好。

参考资料

> https://www.keycdn.com/support/how-does-a-cdn-work
>
> https://blog.csdn.net/dd_orz/article/details/100034049
>
> https://blog.csdn.net/xiangzhihong8/article/details/83147542
>
> https://ns1.com/resources/cname