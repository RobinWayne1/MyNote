# 第六章 复制

为了解决Redis单点的限制性，Redis可以把数据复制成多个副本部署到其他机器，满足故障恢复和负载均衡需求，这就是复制。

## 一、配置

### Ⅰ、建立复制

* `slaveof`配置都是在从节点发起的。
* `info replication`可以查看复制相关状态。

### Ⅱ、断开复制

* 从节点断开复制后并不会抛弃原有数据,只是无法获取主节点上的数据变化。
* **切换主节点会删除从节点当前所有数据,并对新主节点进行复制操作。**

### Ⅲ、只读

默认情况下从节点为只读模式(可配置),**由于复制只能从主节点到从节点,对于从节点的任何修改主节点都无法感知**

,==修改从节点会造成主从数据不一致==。

### Ⅳ、⭐传输延迟

`repl-disable-tcp-nodelay`参数用于控制是否关闭TCP-NODELAY,当关闭时,主节点产生的命令数据无论大小都会及时发送给从节点,主从延迟变小但增加网络带宽消耗；当开启时,主节点会合并较小的TCP数据包从而节省带宽。

## 二、原理

### Ⅰ、复制过程

从节点执行`slaveof`命令:

1. 从节点保存主节点信息并返回,此时复制流程并没有开始

2. 从节点内部通过每秒运行的定时任务维护复制相关逻辑,当定时任务发现存在新的主节点后,则会尝试与该节点建立网络连接。如果从节点无法建立连接,定时任务会无限重试直到连接成功或者执行`slaveof no one`取消复制

3. 发送ping命令,目的是检测主从之间网络socket是否可用和检测主节点当前是否可接受处理命令

4. 权限验证

5. ==同步数据集。主从复制连接正常通信后,主节点把持有的数据全部发送给从节点**(进行全量复制)**==

6. 主节点持续的将写命令发送给从节点，这是异步复制 。

### Ⅱ、==⭐数据同步==

Redis使用`psync`命令完成主从数据同步,同步过程分为全量复制和部分复制。`psync`命令是允许客户端调用的。

**⭐⭐要注意在没有出现特殊情况下，主节点的写命令数据将会源源不断地发送给从节点，而这个发送既不是全量复制也不是部分复制,而是[异步复制](#Ⅵ、异步复制)。**

#### 1、组件支持

`psync`命令要以下组件支持:**主从节点各自的复制偏移量**,**主节点复制积压缓冲区**,**主节点运行id**

##### ①、复制偏移量

​	参与复制的主从节点都会维护自身复制偏移量。主节点在处理完写入命令后**会把命令的字节长度做累加记录进复制偏移量**中,从节点在接收到主节点发送的命令后**也会累加记录自身的偏移量**。根据`master_repl_offset`和`slave_offset`的字节量差值可看出主从节点的复制延迟字节。

##### ②、==复制积压缓冲区==

​	复制积压缓冲区时保存在主节点上的一个固定长度的队列,默认大小为1mb。当主节点有连接的从节点时被创建,**这时主节点响应写命令时,不但会把命令发送给从节点还会写入复制积压缓冲区,==⭐用于保存最近已复制数据的功能。==**

⭐⭐⭐⭐复制积压缓冲区的作用:

* 如果出现网络断线的情况，当从节点重新连上主节点后就要进行 部分复制， 从复制积压缓冲区中取出从节点缺失的数据并发给从节点

##### ③、主节点运行id

Redis节点**启动后都会动态分配**一个40位的十六进制字符串作为运行id,**Redis关闭再启动后,运行id会随之改变**,运行id变化之后从节点将做全量复制。当调优一些内存相关配置时可以使用`debug reload`命令重新加载RDB而保持运行id不变,从而避免不必要的全量复制。

##### ④、`psync`命令

命令格式:`psync {runId} {offset}`

* `{runId}`:表示主节点的运行ID
* `{offset}`:表示从节点的复制偏移量,若是第一次参与复制则为-1

从节点发送此命令给主节点,主节点**根据`psync`参数和自身数据情况决定响应结果时全量复制还是部分复制**

### 2、全量复制和部分复制

##### ①、全量复制

###### ₁、作用时机

全量复制一定会在第一次建立复制时启动,或客户端手动调用`psync runid -1`时也会触发全量复制。

###### ₂、全量复制流程

1. 发送`psync`命令进行同步,由于第一次复制,所以命令中的`{offset}`将会是-1

2. 由于`{offset}`是-1,主节点则回复`+FULLRESYNC`表示进行全量复制

3. 从节点接收到主节点的响应。保存运行ID和偏移量offset

==重点：==

4. ***主节点执行`bgsave`保存RDB文件到本地***

5. ***主节点发送RDB文件给从节点,从节点保存在本地并直接作为数据文件***

6. ***由于从节点==开始接收RDB快照到接收完成期间==,主节点仍然相应命令,主节点把这期间的写命令数据保存在==复制客户端缓冲区==内,当从节点加载完RDB文件,主节点再把缓冲区内的数据发送给从节点以保持数据一致*性** 

7. **从节点清空旧数据**

8. **从节点开始加载RDB文件**

9. **如果从节点开启了AOF功能,从节点会立即做AOF重写以保证全量复制后AOF持久化文件可用**

###### ₃、缺点

全量复制要对整个redis数据库的数据进行持久化，并且要将这个如此大的文件发送给从节点。因此占用的主节点资源将会十分巨大，这个机制并不适合某些只与主节点断线一会儿的从节点。

##### ②、部分复制

###### ₁、作用时机

当从节点出现网络闪断或者命令丢失等情况，从节点就会使用`psync {runid} {offset}`命令要求主节点补发丢失的命令数据,此时主节点就会触发部分复制。

###### ₂、部分复制流程

1. 当主从节点之间网络出现中断

2. 中断期间主节点依然响应命令,但因复制连接中断命令无法发送给从节点,==不过主节点内部存在的复制积压缓冲区依然可以保存最近一段时间的写命令数据==

3. 主从节点网络恢复,由于从节点之前保存了自身已复制的偏移量和主节点的运行ID,因此把他们当作`psync`参数发送给主节点要求进行部分复制

4. 主节点收到`psync`命令后先核对参数runId是否一致,之后根据参数offset在自身复制积压缓冲区查找,如果偏移量之后的数据存在缓冲区中,则对从节点发送`+COUNTINUE`响应

5. 主节点发送数据

#### Ⅴ、心跳

主从节点在建立复制后，它们需要**维护对方的连接状态和复制信息**，所以要有一个心跳机制来完成这个任务。

##### ①、主节点

主节点每隔10秒对从节点发送ping命令判断从节点的存活性和连接状态。

##### ②、从节点

从节点在主线程**每隔1秒发送`replconf ack{offset}`命令,给主节点上报自身当前的复制偏移量**。

主节点除了通过该命令检测从节点的连接状态外，还会检查上报的复制偏移量，检查复制数据是否丢失。如果从节点数据丢失,再从主节点的复制缓冲区中进行部分复制拉取数据

#### Ⅵ、异步复制

写命令的发送过程是异步完成,**也就是主节点自身处理完写命令后将直接返回给客户端。**

而对于修改命令将会异步发送给从节点**,这就造成了从节点的数据相对主节点存在延迟。**

### 三、开发与运维中的问题

#### Ⅰ、读写分离

对于读占比较高的场景，可以通过把一部分读流量分摊到从节点来减轻主节点压力，即只对主节点执行写操作，而只对从结点执行读操作，**这个逻辑要通过客户端重新路由来实现。**



